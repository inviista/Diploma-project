{% extends 'base.html' %}
{% load new_details_modal %}
{% load static %}
{% load calendar_widget %}

{% block content %}
    <div class="flex flex-col mx-6 lg:mx-[100px] max-lg:bg-white mb-6 justify-center">
        <div class="flex flex-row max-lg:flex-col gap-2 pt-[5px]">
            <div class="flex flex-col max-w-[1312px] w-full h-auto lg:shadow-[0px_4px_4px_0px_#0000001A] lg:bg-white mt-3 lg:px-6 pt-5 rounded-[16px]">
                <div class="flex flex-row w-full gap-6 pb-3 border-b-3 border-[#EFEFEF] items-center">
                    <a href="{% url 'news:index' %}" class="h-[29px] flex justify-center">
                        <img class="w-[36px] h-[36px] min-w-9 min-h-9"
                             src="{% static 'img/_src/icons/Frame 115.svg' %}">
                    </a>
                    <div class="flex flex-col">
                        <text class="font-[700] text-[24px]">Новости</text>
                        <text class="font-[500] text-[16px]">
                            Будь в курсе последних событий в сфере ОТ и ТБ — мы собираем и обновляем
                            новости из более чем 100 проверенных источников.
                        </text>
                    </div>
                </div>
                <div class="flex items-center py-6 gap-6">
                    <div class="flex gap-1">
                        <a href="?"
                           class="
                                  flex items-center gap-2 px-3 py-[7.5px] rounded-xl
                                  {% if not request.GET.sort and not request.GET.search %}
                                      bg-[#AF1E2A]
                                  {% else %}
                                      hover:bg-gray-100
                                  {% endif %}
                               "
                        >
                            <text class="
                                    text-xs text-nowrap
                                    {% if not request.GET.sort and not request.GET.search %}
                                        bg-[#AF1E2A] text-white
                                    {% else %}
                                        text-[#AF1E2A]
                                    {% endif %}
                                ">
                                Показать все
                            </text>
                            <div class="w-6 h-6">
                                {% if not request.GET.sort and not request.GET.search %}
                                    <img src="{% static 'img/_src/icons/arrow_drop_down_white.svg' %}"
                                         alt="show all"/>
                                {% else %}
                                    <img src="{% static 'img/_src/icons/arrow_drop_down.svg' %}" alt="show all"/>
                                {% endif %}
                            </div>
                        </a>
                    </div>
                    <form method="get" class="w-full">
                        <label>
                            <input
                                    onchange="this.form.submit()"
                                    type="text"
                                    name="search"
                                    value="{{ request.GET.search }}"
                                    placeholder="Быстрый поиск информации по ключевым словам..."
                                    class="h-[39px] font-[600] text-[12px] text-black bg-[#F5F5F5] rounded-[16px] placeholder:text-[12px] px-3 py-2 focus:outline-none focus:ring-0 placeholder:text-[#1E1E1E] w-full"
                            />
                        </label>
                    </form>
                </div>
                <div class="flex mb-6 overflow-x-auto w-full max-w-[87vw]">
                    <a href="{% url 'news:all_news' %}"
                       class="shrink-0 tab-button text-xs p-[10px] font-medium pb-2 border-b-3
                           {% if not selected_category %}
                               border-red-600 text-red-600
                           {% else %}
                               border-transparent text-gray-600
                           {% endif %}">
                        Все
                    </a>

                    {% for category in categories %}
                        <a href="?category={{ category.slug }}"
                           class="shrink-0 tab-button text-[12px] p-[10px] font-medium pb-2 border-b-3
                               {% if selected_category and selected_category.slug == category.slug %}
                                   border-red-600 text-red-600
                               {% else %}
                                   border-transparent text-gray-600
                               {% endif %}">
                            {{ category.title }}
                        </a>
                    {% endfor %}
                </div>

                <div class="flex flex-col w-full h-auto lg:p-2">
                    <div class="main-news flex flex-col gap-4 pt-[10px]">
                        {% for category in categories %}
                            {% if category.category_article.count > 0 %}
                                <div class="flex flex-col gap-5 pb-[16px]">
                                    <div class="flex flex-row justify-between items-center">
                                        <div class="flex flex-col">
                                            <div class="text-[12px] font-[400] text-[#9E9E9E]">Категория</div>
                                            <h2 class="font-bold text-2xl">{{ category.title }}</h2>
                                        </div>
                                    </div>
                                    {% for article in category.category_article.all %}
                                        <a href="{% url 'news:news_detail' article.alias %}">
                                            {% include 'includes/news/card.html' with article=article %}
                                        </a>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endfor %}
                        {% for article in articles_without_categories %}
                            <a href="{% url 'news:news_detail' article.alias %}">
                                {% include 'includes/news/card.html' with article=article %}
                            </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="hidden lg:flex flex-col max-w-[400px]">
                <div class="flex flex-col w-full h-auto shadow-[0px_4px_4px_0px_#0000001A] bg-white mt-3 p-6 rounded-[16px]">
                    <div class="flex flex-row justify-between w-full gap-[64px] h-[80px] border-b-2 border-[#EFEFEF] font-[700] text-[24px]">
                        Еженедельный дайджест новостей
                    </div>
                    <div class="flex flex-col w-full h-auto">
                        {% render_calendar calendar_year calendar_month events_by_day %}

                        {% include 'includes/news/calendar_news.html' %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function getEventsByDate(date) {
            fetch(`{% url 'news:get_news_by_date' %}?date=${date}`)
                .then((res) => res.text())
                .then((html) => {
                    document.querySelectorAll(".calendarNews").forEach(el => el.innerHTML = html)
                })
                .catch((err) => {
                    console.error("Failed to fetch events:", err);
                });
        }

        document.addEventListener('DOMContentLoaded', function () {
            getEventsByDate(new Date())
        });
    </script>
{% endblock %}
